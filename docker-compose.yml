version: '3.8'

services:
  backend:
    build:
      context: ./taskcurso
      dockerfile: ../docker/backend/Dockerfile
    container_name: laravel_backend
    volumes:
      - ./taskcurso:/var/www/html
    ports:
      - "8000:80"
    depends_on:
      - database
    environment:
      # Variables de Cloudinary
      CLOUDINARY_URL: "cloudinary://298872777779474:bPsMsut064CSWHBD1VfzEtvf6aU@drv2wctxj"
      CLOUDINARY_CLOUD_NAME: "drv2wctxj"
      CLOUDINARY_API_KEY: "298872777779474"
      CLOUDINARY_API_SECRET: "bPsMsut064CSWHBD1VfzEtvf6aU"
      
      # Variables de la aplicación
      APP_ENV: local
      APP_URL: http://backend
      DB_CONNECTION: pgsql
      DB_HOST: database
      DB_PORT: 5432
      DB_DATABASE: sol_store
      DB_USERNAME: user
      DB_PASSWORD: password
      WHATSAPP_NUMBER: "50231271096"
      WHATSAPP_MESSAGE: "Hola, me interesa cotizar un producto personalizado. ¿Podrían, por favor, enviarme qué información necesita para cotizar el producto? ¡Muchas gracias!"
      SANCTUM_STATEFUL_DOMAINS: "frontend:5173"
      SESSION_DOMAIN: "backend"
    networks:
      - app_network

  frontend:
    build:
      context: ./front-vue
      dockerfile: ../docker/frontend/Dockerfile
    container_name: vue_frontend
    volumes:
      - ./front-vue:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      VITE_API_BASE_URL: http://backend/api
      VITE_WHATSAPP_PHONE: "50231271096"
      VITE_WHATSAPP_MESSAGE: "Hola, me interesa cotizar un producto personalizado. ¿Podrían enviarme qué información necesitan para cotizar el producto? ¡Muchas gracias!"
    depends_on:
      - backend
    networks:
      - app_network

  database:
    image: postgres:13
    container_name: postgres_db
    environment:
      POSTGRES_DB: sol_store
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - dbdata:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    networks:
      - app_network

  nginx:
    image: nginx:alpine
    container_name: nginx_proxy
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - app_network

  playwright:
    image: mcr.microsoft.com/playwright:latest
    container_name: playwright_tests
    working_dir: /app
    volumes:
      - ./front-vue:/app
    environment:
      BASE_URL: http://frontend:5173
      CI: "true"
      # Herencia de variables de frontend
      VITE_WHATSAPP_PHONE: ${VITE_WHATSAPP_PHONE}
      VITE_WHATSAPP_MESSAGE: ${VITE_WHATSAPP_MESSAGE}
    command: >
      sh -c "npm ci 
      && npx playwright install 
      && npx playwright test"
    depends_on:
      - frontend
    networks:
      - app_network

  dusk:
    build:
      context: ./taskcurso
      dockerfile: ../docker/backend/Dockerfile
    container_name: laravel_dusk
    volumes:
      - ./taskcurso:/var/www/html
    environment:
      APP_ENV: dusk
      DB_CONNECTION: pgsql
      DB_HOST: database
      DB_PORT: 5432
      DB_DATABASE: sol_store
      DB_USERNAME: user
      DB_PASSWORD: password
      DUSK_DRIVER_URL: http://selenium:4444/wd/hub
      APP_URL: http://backend
      
      # Variables específicas de la aplicación
      WHATSAPP_NUMBER: ${WHATSAPP_NUMBER}
      WHATSAPP_MESSAGE: ${WHATSAPP_MESSAGE}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      SANCTUM_STATEFUL_DOMAINS: ${SANCTUM_STATEFUL_DOMAINS}
      SESSION_DOMAIN: ${SESSION_DOMAIN}
    command: >
      sh -c "composer install 
      && php artisan dusk:install --force
      && php artisan dusk"
    depends_on:
      - database
      - selenium
      - backend
    networks:
      - app_network

  selenium:
    image: selenium/standalone-chrome
    container_name: selenium_chrome
    ports:
      - "4444:4444"
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

volumes:
  dbdata: